<!DOCTYPE html>
<head>
  <link rel="stylesheet" href="stylesheets/style.css">
  <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
  <script type="text/javascript" src="javascripts/tokenlib.js"></script>
  <script type="text/javascript">
    window.addEventListener('load', function () {
      function sendData (accesskey, secretkey) {
        const XHR = new XMLHttpRequest()
        XHR.addEventListener('load', function (event) {
          document.cookie = 'jweToken=' + encodeURI(JSON.parse(event.target.responseText).jweToken)
          // window.location.replace("http://localhost:8000");
          //location.reload()
        })
        XHR.addEventListener('error', function (event) {
          alert('Oops! Something went wrong.')
        })
        var proxyURL = <%- JSON.stringify(proxyURL) %>;
        var proxyPort = <%- JSON.stringify(proxyPort) %>;
        XHR.open('POST', proxyURL + ':' + proxyPort + '/login')
        XHR.setRequestHeader('Content-Type', 'application/json;charset=UTF-8')
        const token = get_bearer_token(accesskey, secretkey)
        XHR.send(JSON.stringify({ token: token }))
      }
      const button = document.getElementById('button')
      button.addEventListener('click', function (event) {
        sendData(document.getElementById('accesskey').value, document.getElementById('secretkey').value)
      })
    })
    var parseCookies = function (request) {
      var list = {}
      var rc = request.headers.cookie
      rc && rc.split(';').forEach(function (cookie) {
        var parts = cookie.split('=')
        list[parts.shift().trim()] = decodeURI(parts.join('='))
      })
      return list
    }
    var checkCookie = function() {
      var lastCookie = document.cookie; // 'static' memory between function calls
      return function() {
        var currentCookie = document.cookie;
        var list = {}
        currentCookie.split(';').forEach(function (cookie) {
          var parts = cookie.split('=')
          list[parts.shift().trim()] = decodeURI(parts.join('='))
        })
        if(list.jweToken){
          document.getElementById("login").style.display = 'none';
          document.getElementById("dashboard-content").style.display = 'block';
        }else{
          document.getElementById("login").style.display = 'block';
          document.getElementById("dashboard-content").style.display = 'none';
        }
        lastCookie = currentCookie; // store latest cookie
      };
    }();
    window.setInterval(checkCookie, 100); // run every 100 ms
  </script>
</head>
<body>
  <div class="main" id="login">
    <p class="sign" align="center">Sign in the Kubernetes Dashboard</p>
    <form class="form1">
      <input class="un " type="text" align="center" placeholder="aws_access_key_id" id="accesskey" required>
      <input class="pass" type="password" align="center" placeholder="aws_secret_access_key" id="secretkey" required>
      <a class="submit" align="center" id="button">Sign in</a>
    </form>
  </div>
  <iframe id="dashboard-content" width="1000" height="700"
          src="http://localhost:8001/api/v1/namespaces/tools/services/http:kubernetes-dashboard:80/proxy"
          sandbox="allow-scripts allow-same-origin">
  </iframe>
</body>
</html>
